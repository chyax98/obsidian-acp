# 权限系统详解

> 深入理解 Obsidian ACP Plugin 的权限管理机制，平衡安全性与便利性。

## 🎯 设计理念

权限系统遵循三个核心原则：

1. **最小权限原则**：Agent 默认没有任何权限，每个操作都需要明确授权
2. **透明可控**：所有权限请求都清晰展示，用户完全掌控
3. **渐进式信任**：支持从完全手动到完全自动的灵活配置

## 🔒 权限层级

### 5 种权限模式

| 模式 | 说明 | 适用场景 | 风险等级 |
|------|------|----------|----------|
| **完全控制** | 每个操作都需要批准 | 初次使用、重要 Vault | 🟢 最安全 |
| **快速编辑** | 自动批准读取，写入仍需确认 | 日常使用 | 🟡 较安全 |
| **完全自动** | 自动批准所有操作 | 受信任的任务 | 🔴 需谨慎 |
| **预配置规则** | 基于规则自动批准 | 特定工作流 | 🟡 可控风险 |
| **仅规划模式** | Agent 只能规划，不能执行 | 学习 AI 思路 | 🟢 完全安全 |

### 当前实现状态

- ✅ **完全控制**（默认）：已实现
- 🚧 **快速编辑**：开发中
- 🚧 **完全自动**：开发中
- 🚧 **预配置规则**：计划中
- 🚧 **仅规划模式**：计划中

## 🛠️ 工具权限分类

### 文件系统工具

| 工具 | 操作 | 默认行为 | 推荐配置 |
|------|------|----------|----------|
| `fs/read` | 读取文件 | 每次询问 | 始终允许（安全） |
| `fs/write` | 写入/创建文件 | 每次询问 | 每次询问（谨慎） |
| `fs/delete` | 删除文件 | 每次询问 | 每次询问（危险） |
| `fs/list` | 列出目录 | 每次询问 | 始终允许（安全） |
| `fs/move` | 移动/重命名文件 | 每次询问 | 每次询问（谨慎） |

### 命令执行工具

| 工具 | 操作 | 默认行为 | 推荐配置 |
|------|------|----------|----------|
| `bash/run` | 执行 shell 命令 | 每次询问 | 每次询问（危险） |
| `bash/background` | 后台运行命令 | 每次询问 | 每次询问（危险） |

### Obsidian 特定工具

| 工具 | 操作 | 默认行为 | 推荐配置 |
|------|------|----------|----------|
| `obsidian/search` | 搜索笔记 | 每次询问 | 始终允许（安全） |
| `obsidian/create_note` | 创建笔记 | 每次询问 | 每次询问（谨慎） |
| `obsidian/open_note` | 打开笔记 | 每次询问 | 始终允许（安全） |

## 📋 权限对话框详解

### 对话框组成

当 Agent 请求权限时，会弹出对话框，包含：

```
┌─────────────────────────────────────────┐
│  🔧 权限请求                            │
├─────────────────────────────────────────┤
│  工具：fs/write                         │
│  描述：写入文件到 Vault                 │
│                                         │
│  文件路径：notes/AI 测试笔记.md         │
│                                         │
│  内容预览：                             │
│  ┌───────────────────────────────────┐ │
│  │ # AI 测试笔记                     │ │
│  │                                   │ │
│  │ 这是由 AI 创建的测试笔记...       │ │
│  │ （共 156 字符）                   │ │
│  └───────────────────────────────────┘ │
│                                         │
│  ⚠️ 警告：此操作会创建新文件            │
│                                         │
│  [ 拒绝 ]  [ 允许一次 ]  [ 始终允许 ]  │
└─────────────────────────────────────────┘
```

### 对话框信息

1. **工具名称**：`fs/write`, `bash/run` 等
2. **操作描述**：清晰说明 Agent 想做什么
3. **关键参数**：文件路径、命令内容等
4. **内容预览**：显示将要写入的内容（可折叠）
5. **风险提示**：危险操作会特别标注

### 操作选项

#### 1. 拒绝

- Agent 会收到权限被拒绝的消息
- Agent 可能：
  - 请求用户手动操作
  - 尝试其他方案
  - 放弃当前任务

#### 2. 允许一次

- 仅批准当前操作
- 下次相同操作仍需确认
- **推荐用于**：写入、删除、命令执行

#### 3. 始终允许

- 自动批准此类操作（基于工具类型）
- 例如：选择"始终允许 fs/read"
- **推荐用于**：读取、列表、搜索

## ⚙️ 配置权限策略

### 方式 1：在设置中配置

```
设置 → ACP Agent Client → 权限管理
```

**全局策略**：
- 默认模式：完全控制 / 快速编辑 / 完全自动
- 工作目录限制：Vault / 当前文件夹 / 自定义

**工具级别策略**：
```
fs/read    → 始终允许
fs/write   → 每次询问
fs/delete  → 每次询问
bash/run   → 每次询问
```

### 方式 2：在对话框中配置

第一次遇到某个工具时，在对话框中选择：
- "允许一次" → 保持默认行为
- "始终允许" → 添加到自动批准列表

### 方式 3：预配置规则（未来功能）

在设置中定义规则：

```json
{
  "rules": [
    {
      "tool": "fs/write",
      "condition": "path.startsWith('notes/drafts/')",
      "action": "allow"
    },
    {
      "tool": "bash/run",
      "condition": "command.startsWith('git ')",
      "action": "allow"
    },
    {
      "tool": "fs/delete",
      "condition": "true",
      "action": "deny"
    }
  ]
}
```

## 🔐 安全边界

### 工作目录限制

Agent 的文件访问范围可配置：

| 模式 | 范围 | 说明 |
|------|------|------|
| **Vault 根目录** | 整个 Vault | 默认，最灵活 |
| **当前笔记文件夹** | 当前文件所在目录 | 最严格，最安全 |
| **自定义路径** | 指定目录 | 适合特定项目 |

**配置方式**：
```
设置 → ACP Agent Client → 工作目录模式
```

### 路径安全检查

插件会自动检查：

1. ✅ **路径遍历攻击**：拒绝 `../` 等跳出工作目录的路径
2. ✅ **隐藏文件保护**：`.obsidian/` 目录需要额外确认
3. ✅ **系统文件保护**：拒绝访问 `/etc`, `/System` 等系统目录
4. ✅ **符号链接检查**：检测并警告符号链接跳出

### 敏感操作保护

某些操作会触发二次确认：

- 🔴 **删除文件**：显示文件大小和最后修改时间
- 🔴 **覆盖大文件**：超过 100KB 的文件覆盖
- 🔴 **批量操作**：一次影响 10+ 个文件
- 🔴 **执行危险命令**：`rm -rf`, `sudo`, `chmod` 等

## 📊 权限审计

### 查看操作历史

所有 Agent 操作都会记录：

```
设置 → ACP Agent Client → 操作历史
```

**记录内容**：
- 时间戳：2025-12-19 23:16:42
- Agent：Claude Code
- 工具：fs/write
- 路径：notes/测试.md
- 结果：成功 / 失败 / 被拒绝
- 用户选择：允许一次 / 始终允许 / 拒绝

### 导出审计日志

```bash
# 导出为 JSON
设置 → ACP Agent Client → 导出日志 → JSON

# 导出为 CSV
设置 → ACP Agent Client → 导出日志 → CSV
```

### 撤销操作（未来功能）

```
操作历史 → 选择操作 → 撤销
```

- ✅ 文件创建 → 删除文件
- ✅ 文件修改 → 恢复到修改前版本
- ⚠️ 文件删除 → 从回收站恢复（如果有）
- ❌ 命令执行 → 无法撤销

## 🎯 最佳实践

### 推荐配置（平衡安全性和便利性）

```
✅ 全局模式：快速编辑
✅ 工作目录：Vault 根目录
✅ fs/read → 始终允许
✅ fs/list → 始终允许
⚠️ fs/write → 每次询问
⚠️ fs/delete → 每次询问
🔴 bash/run → 每次询问
```

### 不同场景的配置建议

#### 场景 1：知识库整理

**任务**：Agent 读取和分析笔记，生成总结

**推荐配置**：
```
✅ fs/read → 始终允许
✅ fs/list → 始终允许
✅ fs/write → 允许一次（检查生成内容）
```

**原因**：读取操作频繁，写入操作需确认内容质量。

---

#### 场景 2：代码重构

**任务**：Agent 重构代码，拆分文件

**推荐配置**：
```
✅ fs/read → 始终允许
⚠️ fs/write → 每次询问（检查代码逻辑）
⚠️ fs/move → 每次询问（确认文件结构）
```

**原因**：代码修改影响大，每次都应仔细检查。

---

#### 场景 3：批量文件处理

**任务**：为 100+ 个笔记添加标签

**推荐配置**：
```
✅ fs/read → 始终允许
✅ fs/write → 始终允许（确认第一次后）
🔴 批量操作警告 → 启用
```

**原因**：批量操作效率优先，但需要批量操作警告。

---

#### 场景 4：命令执行

**任务**：Agent 运行 Git 命令

**推荐配置**：
```
🔴 bash/run → 每次询问（仔细检查命令）
🔴 命令白名单 → git status, git log（未来功能）
```

**原因**：命令执行风险高，必须逐个审查。

### 信任建立流程

**第一次使用 Agent**：
1. 使用"完全控制"模式
2. 对每个操作仔细检查
3. 理解 Agent 的工作方式

**熟悉 Agent 后**：
1. 切换到"快速编辑"模式
2. 对安全操作选择"始终允许"
3. 重要操作仍然手动确认

**完全信任 Agent 后**：
1. 特定任务使用"完全自动"
2. 启用操作审计
3. 定期检查操作历史

## ⚠️ 安全提醒

### 什么情况下拒绝权限？

1. **不理解 Agent 意图**
   - 对话上下文不清楚
   - Agent 的解释不充分

2. **操作超出预期**
   - 请求访问无关文件
   - 修改范围过大

3. **可疑操作**
   - 访问系统目录
   - 执行不熟悉的命令
   - 删除重要文件

### 如何保护重要数据？

1. **定期备份 Vault**
   ```bash
   # 使用 Git
   git init
   git add .
   git commit -m "backup"
   
   # 或使用 Obsidian Sync / 云盘同步
   ```

2. **使用工作目录限制**
   - 重要笔记放在专门目录
   - 工作目录设置为测试目录

3. **关键文件设为只读**
   ```bash
   chmod 444 重要笔记.md
   ```

4. **使用"仅规划模式"**
   - Agent 只生成计划，不执行
   - 手动执行每一步

### 发现可疑行为怎么办？

1. **立即拒绝权限**
2. **断开 Agent 连接**
3. **查看操作历史**
4. **检查修改的文件**
5. **报告问题**（GitHub Issues）

## 🔗 相关资源

- [快速开始](./GETTING_STARTED.md) - 5 分钟上手
- [Agent 配置](./AGENT_SETUP.md) - 配置各个 Agent
- [常见问题 FAQ](./FAQ.md) - 权限相关问题
- [GitHub Issues](https://github.com/YOUR_USERNAME/obsidian-acp/issues) - 报告安全问题

---

**记住**：权限系统是你的保护伞。合理配置权限，既能享受 AI 的便利，又能保护数据安全。 🛡️
