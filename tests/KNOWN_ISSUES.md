# 已知问题记录

> **版本**: 0.1.0
> **更新日期**: 2025-12-18

---

## 说明

本文档记录 ACP 插件开发过程中已知的问题、限制和待改进项。

---

## 1. 架构相关

### 1.1 T12 工具调用渲染未完成

**状态**: 🔨 进行中

**描述**: T12 任务（工具调用渲染）正在由 Claude-Agent-T12 并行执行，尚未完全完成。

**影响**:
- 工具调用状态可能无法正确渲染
- Diff 渲染可能不可用
- 终端输出渲染可能缺失

**临时方案**:
- 工具调用会在消息中以文本形式显示
- 等待 T12 完成后集成

**预计解决**: T12 任务完成后

---

## 2. 平台兼容性

### 2.1 Windows 路径处理

**状态**: ⚠️ 未充分测试

**描述**: Windows 平台的路径分隔符（反斜杠）和盘符处理可能存在问题。

**影响**:
- 文件操作可能失败
- 工作目录解析可能错误

**临时方案**:
- 使用相对路径
- 或在 macOS/Linux 上测试

**建议测试**:
- Windows 环境下的完整功能测试
- 路径分隔符处理测试

### 2.2 CLI 检测跨平台

**状态**: ⚠️ 部分实现

**描述**: CLI 检测使用 `which`（Unix）和 `where`（Windows），但不同平台的输出格式可能不一致。

**影响**:
- 某些平台上 Agent 检测可能失败
- 需要手动配置 Agent 路径

**临时方案**:
- 在设置中手动指定 Agent CLI 路径

---

## 3. 功能限制

### 3.1 会话持久化格式

**状态**: ✅ 已实现，但有限制

**描述**: 会话持久化使用 Obsidian 的 `loadData/saveData` API，所有数据存储在单个 JSON 文件中。

**限制**:
- 大量消息可能导致性能问题
- 无法按会话分片存储

**影响**:
- 长时间使用后加载变慢
- 大型会话可能占用大量内存

**建议改进**:
- 实现会话分片存储
- 添加自动清理旧会话功能
- 实现消息分页加载

### 3.2 流式输出渲染

**状态**: ✅ 已实现，但可能有性能问题

**描述**: 流式输出通过频繁 DOM 更新实现。

**影响**:
- 大量快速更新可能导致 UI 卡顿
- 长文本渲染可能影响性能

**建议改进**:
- 实现节流（throttle）机制
- 使用虚拟滚动
- 优化 Markdown 渲染性能

### 3.3 多会话并行

**状态**: ❌ 不支持

**描述**: 当前设计每次只能连接一个 Agent，不支持多个会话并行。

**限制**:
- 无法同时与多个 Agent 对话
- 切换 Agent 需要断开当前连接

**建议改进**:
- 实现多 AcpConnection 实例管理
- 支持多个 ChatView 标签页
- 实现会话切换机制

---

## 4. 安全性问题

### 4.1 权限管理粒度

**状态**: ⚠️ 基础实现

**描述**: 权限管理为"允许一次"/"始终允许"，缺乏更细粒度的控制。

**问题**:
- "始终允许"可能带来安全风险
- 无法针对特定路径或命令设置规则

**建议改进**:
- 实现基于路径的权限规则
- 添加权限白名单/黑名单
- 实现权限审计日志

### 4.2 命令执行权限

**状态**: ⚠️ 需要额外验证

**描述**: Agent 可能请求执行任意命令，需要严格的权限控制。

**风险**:
- 恶意命令执行
- 系统文件被修改

**建议改进**:
- 实现命令白名单
- 添加危险命令警告
- 禁止某些高危操作（如 rm -rf）

---

## 5. 用户体验

### 5.1 错误消息不够友好

**状态**: ⚠️ 需要改进

**描述**: 某些错误消息直接显示技术细节，用户可能难以理解。

**例子**:
- "ENOENT: no such file or directory"
- "Connection timeout after 30000ms"

**建议改进**:
- 提供用户友好的错误消息
- 添加错误原因和解决建议
- 实现错误分类和本地化

### 5.2 无 Agent 切换确认

**状态**: ⚠️ 可能导致误操作

**描述**: 切换 Agent 时会直接断开当前连接，无确认提示。

**风险**:
- 用户可能意外断开会话
- 未保存的消息可能丢失

**建议改进**:
- 添加切换确认弹窗
- 提示"当前会话将被中断"
- 提供"保存当前会话"选项

### 5.3 加载状态反馈

**状态**: ⚠️ 部分实现

**描述**: 某些操作（如连接 Agent）缺乏明确的加载状态。

**影响**:
- 用户不知道操作是否正在进行
- 可能重复点击按钮

**建议改进**:
- 添加加载动画
- 显示操作进度
- 实现操作超时提示

---

## 6. 性能问题

### 6.1 大量消息渲染

**状态**: ⚠️ 未优化

**描述**: 所有消息一次性渲染到 DOM，可能导致性能问题。

**影响**:
- 大量消息时滚动卡顿
- 内存占用增加

**建议改进**:
- 实现虚拟滚动
- 按需加载消息（分页）
- 限制 DOM 节点数量

### 6.2 频繁的数据保存

**状态**: ⚠️ 未优化

**描述**: 每次消息更新都保存到磁盘，可能影响性能。

**影响**:
- 频繁 I/O 操作
- 可能影响 Obsidian 响应速度

**建议改进**:
- 实现保存去抖（debounce）
- 批量保存消息
- 只保存关键更新

---

## 7. 兼容性问题

### 7.1 Obsidian API 版本依赖

**状态**: ✅ 当前版本正常

**描述**: 插件依赖 Obsidian 最新 API，旧版本可能不兼容。

**最低要求**: Obsidian 1.0.0+

**建议**:
- 在 `manifest.json` 中明确最低版本要求
- 测试旧版本兼容性

### 7.2 Node.js 模块依赖

**状态**: ✅ 已处理

**描述**: 使用了 Node.js 的 `child_process` 和 `path` 模块。

**注意**:
- 插件标记为 `isDesktopOnly: true`
- 无法在移动端使用

---

## 8. 测试相关

### 8.1 缺乏自动化测试

**状态**: ❌ 未实现

**描述**: 当前只有手动测试清单，缺乏自动化测试。

**影响**:
- 回归测试成本高
- 难以保证代码质量

**建议**:
- 添加单元测试（Jest）
- 实现集成测试
- 设置 CI/CD 流程

### 8.2 边界情况测试不足

**状态**: ⚠️ 需要补充

**描述**: 某些边界情况可能未充分测试。

**待测试场景**:
- 超长消息（>10000 字）
- 特殊字符处理（emoji, Unicode）
- 网络中断和恢复
- Agent 崩溃恢复
- 并发请求处理

---

## 9. 文档缺失

### 9.1 API 文档

**状态**: ❌ 未编写

**描述**: 缺乏代码 API 文档。

**影响**:
- 开发者难以理解代码结构
- 难以贡献代码

**建议**:
- 添加 JSDoc 注释
- 生成 API 文档
- 提供开发者指南

### 9.2 用户文档

**状态**: ❌ 未完成

**描述**: T16 任务（用户文档）尚未执行。

**缺失内容**:
- 快速开始指南
- 功能说明
- 常见问题 FAQ
- 截图和演示

**预计**: T16 任务完成后补充

---

## 10. 待实现功能

### 10.1 会话搜索

**状态**: ❌ 未实现

**描述**: 无法搜索历史会话和消息。

**建议**:
- 实现全文搜索
- 支持按日期筛选
- 支持按 Agent 类型筛选

### 10.2 消息导出

**状态**: ❌ 未实现

**描述**: 无法导出会话为 Markdown 或其他格式。

**建议**:
- 支持导出为 Markdown 文件
- 支持导出为 JSON（备份）
- 支持批量导出

### 10.3 多语言支持

**状态**: ❌ 未实现

**描述**: UI 文本硬编码为中文/英文，无国际化支持。

**建议**:
- 实现 i18n 框架
- 提供语言切换选项
- 支持更多语言

### 10.4 自定义主题

**状态**: ❌ 未实现

**描述**: ChatView 样式固定，无法自定义。

**建议**:
- 支持自定义 CSS
- 提供主题预设
- 适配 Obsidian 主题

---

## 优先级分类

### P0 - 阻塞性问题

- 无（当前版本可以基本使用）

### P1 - 高优先级

1. T12 工具调用渲染完成
2. Windows 平台测试和修复
3. 权限管理安全性增强

### P2 - 中优先级

1. 性能优化（大量消息渲染）
2. 错误消息改进
3. 自动化测试添加

### P3 - 低优先级

1. 多会话并行支持
2. 会话搜索和导出
3. 多语言支持
4. 自定义主题

---

## 贡献指南

如果你发现新的问题，请：

1. 检查是否已在本文档中记录
2. 如果是新问题，请提交 Issue 或 Pull Request
3. 包含以下信息：
   - 问题描述
   - 重现步骤
   - 预期行为
   - 实际行为
   - 环境信息（OS, Obsidian 版本等）

---

## 变更日志

| 日期 | 版本 | 变更内容 |
|------|------|---------|
| 2025-12-18 | 0.1.0 | 初始版本，记录已知问题 |
