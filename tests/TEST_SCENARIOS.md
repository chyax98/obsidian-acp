# 测试场景说明

> **版本**: 0.1.0
> **日期**: 2025-12-18

---

## 概述

本文档描述 ACP 插件的各种测试场景，包括正常流程、边界情况和错误处理。

---

## 场景分类

1. **基础功能场景** - 核心功能的正常使用流程
2. **边界场景** - 极限情况和特殊输入
3. **错误场景** - 异常情况和错误处理
4. **性能场景** - 压力测试和性能验证
5. **安全场景** - 权限和安全相关测试

---

## 1. 基础功能场景

### 场景 1.1: 首次使用流程

**目标**: 验证用户首次使用插件的完整流程

**前置条件**:
- Obsidian 已安装
- 插件已安装到 Vault
- Claude Code CLI 已安装

**测试步骤**:
1. 启动 Obsidian
2. 启用 ACP 插件
3. 点击左侧 ACP 图标打开 ChatView
4. 在 Agent 选择器中选择 "Claude Code"
5. 点击"连接"按钮
6. 等待连接成功
7. 在输入框输入 "你好，请介绍一下你自己"
8. 点击发送
9. 等待 Agent 回复

**预期结果**:
- 所有步骤顺利完成
- Agent 成功连接
- 消息正常发送和接收
- UI 反馈清晰

**验收标准**:
- 连接时间 < 5 秒
- 消息响应时间合理
- 无错误日志

---

### 场景 1.2: 文件创建流程

**目标**: 验证 Agent 创建文件的完整流程

**前置条件**:
- Agent 已连接
- 会话已创建

**测试步骤**:
1. 发送消息: "请在我的 Vault 中创建一个名为 test-demo.md 的文件，内容为 '# 测试文件\n\n这是一个测试文件。'"
2. 等待权限请求弹窗出现
3. 检查弹窗内容（工具名称、文件路径、操作描述）
4. 点击"允许一次"
5. 等待 Agent 完成操作
6. 在 Obsidian 中检查文件是否创建成功

**预期结果**:
- 权限弹窗正确显示
- 文件成功创建
- 文件内容正确
- Agent 回复确认信息

**验收标准**:
- 文件路径正确（在 Vault 根目录）
- 文件内容与请求一致
- 无多余文件创建

---

### 场景 1.3: 文件读取流程

**目标**: 验证 Agent 读取文件的完整流程

**前置条件**:
- Agent 已连接
- Vault 中存在测试文件 `test-read.md`

**测试步骤**:
1. 在 Vault 中手动创建 `test-read.md`，内容为 "Hello World"
2. 发送消息: "请读取 test-read.md 文件并告诉我其内容"
3. 等待权限请求弹窗
4. 点击"允许一次"
5. 等待 Agent 回复

**预期结果**:
- 权限弹窗正确显示文件路径
- Agent 成功读取文件
- Agent 回复包含文件内容 "Hello World"

---

### 场景 1.4: 多轮对话

**目标**: 验证多轮对话的上下文保持

**前置条件**:
- Agent 已连接

**测试步骤**:
1. 发送消息 A: "我的名字是张三"
2. 等待回复
3. 发送消息 B: "我的名字是什么？"
4. 等待回复
5. 检查回复是否包含 "张三"

**预期结果**:
- Agent 能够记住上下文
- 回复正确引用之前的对话内容

---

### 场景 1.5: Markdown 渲染

**目标**: 验证各种 Markdown 元素的渲染

**前置条件**:
- Agent 已连接

**测试步骤**:
1. 发送消息: "请生成一个 Markdown 示例，包含标题、列表、代码块、粗体、斜体"
2. 等待 Agent 回复
3. 检查渲染结果

**预期结果**:
- 标题正确渲染为不同大小
- 列表有正确缩进
- 代码块有语法高亮
- 粗体和斜体正确显示

**验收标准**:
- 所有 Markdown 元素正确渲染
- 样式与 Obsidian 主题一致

---

### 场景 1.6: 会话持久化

**目标**: 验证会话保存和恢复

**前置条件**:
- Agent 已连接
- 已发送多条消息

**测试步骤**:
1. 发送 3 条测试消息（记录内容）
2. 关闭 ChatView
3. 重新打开 ChatView
4. 检查消息历史

**预期结果**:
- 所有消息正确恢复
- 消息顺序正确
- 时间戳正确

---

## 2. 边界场景

### 场景 2.1: 超长消息

**目标**: 测试系统处理超长消息的能力

**测试数据**:
- 用户消息: 10,000 字的文本
- Agent 回复: 预期也会很长

**测试步骤**:
1. 准备 10,000 字的测试文本（可以是重复内容）
2. 粘贴到输入框
3. 发送消息
4. 观察渲染性能

**预期结果**:
- 消息正常发送
- 渲染流畅，无卡顿
- 滚动性能良好

**性能指标**:
- 渲染时间 < 2 秒
- 滚动帧率 > 30 FPS

---

### 场景 2.2: 特殊字符处理

**目标**: 测试特殊字符的处理

**测试数据**:
```
Emoji: 😀 🚀 ❤️
Unicode: 中文 日本語 한국어 العربية
特殊符号: <>&"'`{}[]()
Markdown 冲突字符: *_~`#
```

**测试步骤**:
1. 发送包含上述特殊字符的消息
2. 观察渲染结果

**预期结果**:
- 所有字符正确显示
- 无 HTML 转义问题
- 无 Markdown 解析错误

---

### 场景 2.3: 空消息处理

**目标**: 测试边界情况

**测试步骤**:
1. 尝试发送空消息（只有空格）
2. 观察系统行为

**预期结果**:
- 发送按钮禁用或显示错误提示
- 不发送空消息到 Agent

---

### 场景 2.4: 快速连续发送

**目标**: 测试并发请求处理

**测试步骤**:
1. 快速发送 3 条消息（间隔 < 1 秒）
2. 观察系统行为

**预期结果**:
- 所有消息按顺序处理
- 不丢失消息
- UI 正确显示等待状态

---

### 场景 2.5: 大量历史消息

**目标**: 测试大量消息的渲染性能

**测试步骤**:
1. 发送 100 条消息（可以使用脚本自动化）
2. 滚动查看所有消息
3. 重新打开 ChatView，观察加载时间

**预期结果**:
- 所有消息正确显示
- 滚动流畅
- 加载时间 < 3 秒

---

## 3. 错误场景

### 场景 3.1: Agent 未安装

**目标**: 测试连接到未安装的 Agent

**前置条件**:
- 系统未安装 Codex（或其他 Agent）

**测试步骤**:
1. 选择未安装的 Agent（如 Codex）
2. 点击"连接"
3. 观察错误处理

**预期结果**:
- 显示友好的错误消息（如 "Codex CLI 未安装"）
- 提供安装指引或文档链接
- 不导致插件崩溃

---

### 场景 3.2: 连接超时

**目标**: 测试连接超时处理

**模拟方法**:
- 修改超时时间为 5 秒（代码层面）
- 或使用网络限制工具

**测试步骤**:
1. 触发连接超时
2. 观察错误处理

**预期结果**:
- 显示超时错误消息
- 提供重试选项
- 连接状态正确重置

---

### 场景 3.3: Agent 进程崩溃

**目标**: 测试 Agent 意外退出的处理

**测试步骤**:
1. 连接到 Agent
2. 在系统进程管理器中手动杀死 Agent 进程
3. 尝试发送消息
4. 观察系统行为

**预期结果**:
- 检测到连接断开
- 显示错误消息（如 "连接已断开"）
- 提供重新连接选项
- 不导致插件崩溃

---

### 场景 3.4: 无效文件路径

**目标**: 测试文件操作错误处理

**测试步骤**:
1. 发送消息: "请读取 /invalid/path/test.md"
2. 允许权限
3. 观察错误处理

**预期结果**:
- Agent 返回文件不存在错误
- 插件正确显示错误消息
- 不导致会话中断

---

### 场景 3.5: 权限拒绝

**目标**: 测试权限拒绝的处理

**测试步骤**:
1. 发送触发权限请求的消息
2. 点击"拒绝一次"
3. 观察 Agent 行为

**预期结果**:
- Agent 收到权限拒绝响应
- Agent 回复说明操作被拒绝
- 会话继续，可以发送新消息

---

### 场景 3.6: 网络中断

**目标**: 测试网络中断恢复

**模拟方法**:
- 暂停 Agent 进程（Ctrl+Z）
- 或使用网络模拟工具

**测试步骤**:
1. 连接到 Agent
2. 模拟网络中断
3. 尝试发送消息
4. 恢复网络
5. 观察系统行为

**预期结果**:
- 检测到连接问题
- 显示错误或重试提示
- 网络恢复后可以正常使用

---

## 4. 性能场景

### 场景 4.1: 压力测试 - 连续发送

**目标**: 测试系统在高负载下的表现

**测试步骤**:
1. 连续发送 50 条消息（间隔 2 秒）
2. 监控内存占用
3. 监控 CPU 使用率
4. 检查 UI 响应性

**性能指标**:
- 内存增长 < 200MB
- CPU 使用率 < 50%
- UI 保持流畅（帧率 > 30 FPS）

---

### 场景 4.2: 压力测试 - 大量历史

**目标**: 测试大量历史数据的加载性能

**测试步骤**:
1. 创建包含 500 条消息的会话（脚本生成）
2. 打开 ChatView
3. 测量加载时间
4. 测量内存占用

**性能指标**:
- 加载时间 < 5 秒
- 内存占用 < 300MB
- 滚动流畅

---

### 场景 4.3: 内存泄漏检查

**目标**: 检测内存泄漏

**测试步骤**:
1. 打开 ChatView
2. 发送 20 条消息
3. 关闭 ChatView
4. 重复步骤 1-3 共 10 次
5. 使用开发者工具检查内存占用

**预期结果**:
- 内存占用不持续增长
- 关闭 ChatView 后内存释放

---

### 场景 4.4: 流式输出性能

**目标**: 测试流式输出的渲染性能

**测试步骤**:
1. 发送触发长回复的消息
2. 观察流式更新性能
3. 监控 CPU 和内存

**性能指标**:
- 每次更新渲染时间 < 16ms（60 FPS）
- CPU 使用率 < 60%

---

## 5. 安全场景

### 场景 5.1: 路径遍历攻击

**目标**: 测试路径安全性

**测试步骤**:
1. 发送消息: "请读取 ../../sensitive-file.txt"
2. 观察系统行为

**预期结果**:
- 路径被规范化或拒绝
- 无法访问 Vault 外的文件（除非明确允许）
- 显示安全警告

---

### 场景 5.2: 命令注入

**目标**: 测试命令执行安全性

**测试步骤**:
1. 发送消息: "请执行 'ls; rm -rf /'"
2. 观察系统行为

**预期结果**:
- 危险命令被阻止或警告
- 权限请求明确显示命令内容
- 不执行未经授权的命令

---

### 场景 5.3: 权限持久化验证

**目标**: 验证"始终允许"功能

**测试步骤**:
1. 触发文件写入权限请求
2. 选择"始终允许"
3. 再次触发相同类型的请求
4. 检查是否跳过权限弹窗

**预期结果**:
- 第二次请求直接执行，无需再次确认
- 权限设置被正确保存
- 可以在设置中撤销权限

---

### 场景 5.4: 敏感信息泄露

**目标**: 检查敏感信息处理

**测试步骤**:
1. 发送包含 API Key 或密码的消息
2. 检查日志和存储
3. 检查会话持久化数据

**预期结果**:
- 敏感信息不出现在日志中（或被脱敏）
- 存储的数据经过适当处理

---

## 6. 用户体验场景

### 场景 6.1: 断线重连

**目标**: 测试用户友好的重连流程

**测试步骤**:
1. 连接到 Agent
2. Agent 意外断开
3. 观察 UI 提示
4. 点击重连按钮

**预期结果**:
- 明确的断线提示
- 一键重连功能
- 会话状态恢复（如果可能）

---

### 场景 6.2: 操作取消

**目标**: 测试取消操作的流程

**测试步骤**:
1. 发送长时间执行的消息
2. 点击"取消"按钮
3. 观察系统行为

**预期结果**:
- Agent 停止处理
- 显示取消确认消息
- 可以继续发送新消息

---

### 场景 6.3: 多 Agent 切换

**目标**: 测试切换 Agent 的流程

**测试步骤**:
1. 连接到 Claude Code
2. 发送几条消息
3. 断开连接
4. 切换到 Codex
5. 连接
6. 发送消息

**预期结果**:
- 切换流程顺畅
- 历史消息正确保存
- 新会话正确创建

---

## 测试执行建议

### 优先级

1. **P0 - 关键场景**: 1.1, 1.2, 1.3, 3.1, 3.3
2. **P1 - 重要场景**: 1.4, 1.5, 1.6, 2.1, 3.2, 3.4
3. **P2 - 常规场景**: 所有其他场景

### 测试环境

- **开发环境**: macOS (首选), Windows, Linux
- **Obsidian 版本**: 最新稳定版 + 前一个版本
- **Agent**: 至少测试 Claude Code 和 Codex

### 测试顺序

1. 先测试基础功能场景
2. 然后测试边界场景
3. 最后测试错误和性能场景

### 测试记录

- 使用 `MANUAL_TESTS.md` 记录测试结果
- 发现问题记录到 `KNOWN_ISSUES.md`
- 严重问题立即修复

---

## 自动化测试建议

### 可自动化场景

- 连接/断开测试
- 消息发送/接收测试
- 基础 Markdown 渲染测试
- 性能基准测试

### 需要手动测试场景

- UI 交互
- 权限弹窗
- 视觉效果
- 用户体验

---

## 附录：测试脚本示例

### 生成测试会话

```javascript
// 在浏览器控制台运行
async function generateTestSession(messageCount) {
    for (let i = 0; i < messageCount; i++) {
        await sendMessage(`测试消息 ${i + 1}`);
        await sleep(2000);
    }
}
```

### 内存监控

```javascript
// 在浏览器控制台运行
setInterval(() => {
    if (performance.memory) {
        console.log('Memory:', {
            used: (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2) + ' MB',
            total: (performance.memory.totalJSHeapSize / 1024 / 1024).toFixed(2) + ' MB'
        });
    }
}, 5000);
```

---

## 变更日志

| 日期 | 版本 | 变更内容 |
|------|------|---------|
| 2025-12-18 | 0.1.0 | 初始版本，定义测试场景 |
